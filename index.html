<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Datos - Defensoría Civil y Comercial 6</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase (módulo) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, set, get, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC871IwG89d3yd-BUY9tj2q0_gmBV3AMfM",
      authDomain: "datos-partes.firebaseapp.com",
      databaseURL: "https://datos-partes-default-rtdb.firebaseio.com",
      projectId: "datos-partes",
      storageBucket: "datos-partes.firebasestorage.app",
      messagingSenderId: "277413385546",
      appId: "1:277413385546:web:9863aaa081727a84479db3",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Exponer utilidades a window para el script no-módulo
    window.db = db;
    window.dbRef = ref;
    window.dbPush = push;
    window.dbSet = set;
    window.dbGet = get;
    window.dbOn = onValue;
    window.dbRemove = remove;
    window.dbUpdate = update;
  </script>

  <style>
    :root {
      --primary-color: #2563eb;
      --bg-color: #f8f9fa;
      --text-color: #111827;
      --muted-text: #6b7280;
      --border-color: #e5e7eb;
      --white: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
    }

    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--white);
      color: var(--text-color);
      font-size: 0.9em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn i { margin-right: 6px; }

    .btn-primary { background: var(--primary-color); border: 1px solid var(--primary-color); color: var(--white); }
    .btn-danger { background: #dc2626; border: 1px solid #dc2626; color: var(--white); }
    .btn-warning { background: #f59e0b; border: 1px solid #f59e0b; color: var(--white); }

    .btn:hover { filter: brightness(0.96); }

    .main-container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }

    .form-section {
      background: var(--white);
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    .form-section.active { display: block; }
    .section-header { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .form-section h2 { font-size: 1.1rem; margin: 0 0 10px 0; color: var(--primary-color); font-weight: 600; }
    .form-section p { margin: 0; color: var(--muted-text); font-size: 0.9rem; }

    .form-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 0.85em; font-weight: 600; color: #374151; }
    .form-group input, .form-group select, .form-group textarea {
      padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: #fcfcfd; font-size: 0.92em;
    }
    .form-group textarea { min-height: 72px; resize: vertical; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08); }

    .table-container { overflow-x: auto; margin-top: 14px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.92em; min-width: 600px; }
    table th, table td { border: 1px solid var(--border-color); padding: 8px 10px; text-align: left; }
    table th { background: #f3f4f6; font-weight: 600; }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }

    .toggle-container { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 12px 0; flex-wrap: wrap; gap: 10px; }
    .search-box input {
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9em;
      width: 240px;
      max-width: 100%;
    }

    .muted { color: var(--muted-text); font-size: 0.85rem; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .topbar { justify-content: flex-start; }
      .btn { flex: 1 1 45%; text-align: center; }
      .section-header { flex-direction: column; align-items: flex-start; }
      .toggle-container { flex-direction: column; align-items: stretch; }
      .search-box input { width: 100%; }
    }

    @media (max-width: 480px) {
      .btn { flex: 1 1 100%; }
      table { font-size: 0.8em; min-width: 480px; }
    }

  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" onclick="mostrarSeccion('personal')"><i class="fas fa-user"></i>Datos Personales</button>
    <button class="btn" onclick="mostrarSeccion('judicial')"><i class="fas fa-gavel"></i>Judicial</button>
    <button class="btn" onclick="mostrarSeccion('medica')"><i class="fas fa-stethoscope"></i>Médica</button>
    <button class="btn" onclick="mostrarSeccion('laboral')"><i class="fas fa-briefcase"></i>Laboral</button>
    <button class="btn" onclick="mostrarSeccion('listado')"><i class="fas fa-list"></i>Listado</button>
  </div>

  <div class="main-container">
    <!-- PERSONAL -->
    <form id="personalForm" class="form-section active">
      <div class="section-header">
        <h2>Datos Personales</h2>
        <p class="muted">Cargue múltiples registros. Seleccione una fila para editar.</p>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Apellido</label><input name="apellido" type="text" /></div>
        <div class="form-group"><label>Nombre</label><input name="nombre" type="text" /></div>
        <div class="form-group"><label>DNI</label><input name="dni" type="text" /></div>
        <div class="form-group"><label>Edad</label><input name="edad" type="number" /></div>
        <div class="form-group"><label>Domicilio</label><input name="domicilio" type="text" /></div>
        <div class="form-group"><label>Teléfono</label><input name="telefono" type="text" /></div>
        <div class="form-group"><label>Email</label><input name="email" type="email" /></div>
        <div class="form-group"><label>Estado Civil</label><input name="estadoCivil" type="text" /></div>
        <div class="form-group"><label>Nacionalidad</label><input name="nacionalidad" type="text" /></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end">
        <button type="button" class="btn" onclick="resetForm('personalForm')">Limpiar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Apellido</th><th>Nombre</th><th>DNI</th><th>Edad</th><th>Domicilio</th><th>Teléfono</th><th>Email</th><th>Estado Civil</th><th>Nacionalidad</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="personalTable"></tbody>
        </table>
      </div>
    </form>

    <!-- JUDICIAL -->
    <form id="judicialForm" class="form-section">
      <div class="section-header">
        <h2>Datos Judiciales</h2>
        <p class="muted">Puede cargar más de un registro por persona.</p>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Número de Causa</label><input name="numCausa" type="text" /></div>
        <div class="form-group"><label>Juzgado</label><input name="juzgado" type="text" /></div>
        <div class="form-group"><label>Jurisdicción</label><input name="jurisdiccion" type="text" /></div>
        <div class="form-group"><label>Secretaría</label><input name="secretaria" type="text" /></div>
        <div class="form-group"><label>Carátula</label><input name="caratula" type="text" /></div>
        <div class="form-group"><label>Situación</label><textarea name="situacion"></textarea></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end">
        <button type="button" class="btn" onclick="resetForm('judicialForm')">Limpiar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>N° Causa</th><th>Juzgado</th><th>Jurisdicción</th><th>Secretaría</th><th>Carátula</th><th>Situación</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="judicialTable"></tbody>
        </table>
      </div>
    </form>

    <!-- MÉDICA -->
    <form id="medicaForm" class="form-section">
      <div class="section-header">
        <h2>Datos Médicos</h2>
        <p class="muted">Registre historial y tratamientos.</p>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Diagnóstico</label><textarea name="diagnostico"></textarea></div>
        <div class="form-group"><label>Tratamiento</label><textarea name="tratamiento"></textarea></div>
        <div class="form-group"><label>Médico</label><input name="medico" type="text" /></div>
        <div class="form-group"><label>Centro Médico</label><input name="centroMedico" type="text" /></div>
        <div class="form-group"><label>Obra Social</label><input name="obraSocial" type="text" /></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end">
        <button type="button" class="btn" onclick="resetForm('medicaForm')">Limpiar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Diagnóstico</th><th>Tratamiento</th><th>Médico</th><th>Centro Médico</th><th>Obra Social</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="medicaTable"></tbody>
        </table>
      </div>
    </form>

    <!-- LABORAL -->
    <form id="laboralForm" class="form-section">
      <div class="section-header">
        <h2>Datos Laborales</h2>
        <p class="muted">Soporta múltiples antecedentes laborales.</p>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Empresa</label><input name="empresa" type="text" /></div>
        <div class="form-group"><label>Puesto</label><input name="puesto" type="text" /></div>
        <div class="form-group"><label>Antigüedad</label><input name="antiguedad" type="text" /></div>
        <div class="form-group"><label>Dirección</label><input name="direccion" type="text" /></div>
        <div class="form-group"><label>Teléfono Empresa</label><input name="telefonoEmpresa" type="text" /></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end">
        <button type="button" class="btn" onclick="resetForm('laboralForm')">Limpiar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Empresa</th><th>Puesto</th><th>Antigüedad</th><th>Dirección</th><th>Teléfono Empresa</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="laboralTable"></tbody>
        </table>
      </div>
    </form>

    <!-- LISTADO GLOBAL -->
    <div id="listado" class="form-section">
      <div class="section-header">
        <h2>Listado de Registros</h2>
        <p class="muted">Cambie entre vista completa o compacta y filtre por DNI/Nombre/Apellido.</p>
      </div>
      <div class="toggle-container">
        <div class="search-box">
          <input id="searchInput" type="text" placeholder="Buscar por DNI, Nombre o Apellido..." oninput="filterListado()" />
        </div>
        <div>
          <button class="btn" type="button" onclick="toggleListado('completo')">Listado Completo</button>
          <button class="btn" type="button" onclick="toggleListado('compacto')">Listado Compacto</button>
        </div>
      </div>
      <div id="listadoContainer" class="table-container"></div>
    </div>
  </div>

  <!-- Lógica principal (no-módulo) -->
  <script>
    let listadoData = {};
    let listadoTipo = 'completo';

    function mostrarSeccion(id) {
      // Ocultar todas
      document.querySelectorAll('.form-section').forEach((s) => s.classList.remove('active'));

      // Render de listado si corresponde
      if (id === 'listado') {
        renderListado(listadoTipo);
      }

      // Resolver destino de forma segura (evita TypeError si no existe)
      const targetId = id === 'listado' ? 'listado' : id + 'Form';
      const target = document.getElementById(targetId);
      if (target) {
        target.classList.add('active');
      } else {
        console.warn('Sección no encontrada:', targetId);
      }
    }

    function resetForm(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      form.reset();
      delete form.dataset.editId;
      delete form.dataset.path;
    }

    function toggleListado(tipo) {
      listadoTipo = tipo;
      renderListado(tipo);
    }

    async function renderListado(tipo) {
      const container = document.getElementById('listadoContainer');
      if (!container) return;
      container.innerHTML = '';
      const sections = ['personal', 'judicial', 'medica', 'laboral'];
      listadoData = {};

      for (const path of sections) {
        const sectionRef = window.dbRef(window.db, path);
        const snapshot = await window.dbGet(sectionRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          listadoData[path] = data;

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');

          const firstItem = Object.values(data)[0] || {};
          const keys = Object.keys(firstItem);

          const headerRow = document.createElement('tr');
          keys.forEach((k) => {
            const showCompact = ['apellido', 'nombre', 'dni', 'empresa', 'numCausa', 'diagnostico'].includes(k);
            if (tipo === 'completo' || (tipo === 'compacto' && showCompact)) {
              const th = document.createElement('th');
              th.textContent = k;
              headerRow.appendChild(th);
            }
          });
          thead.appendChild(headerRow);

          Object.values(data).forEach((item) => {
            const row = document.createElement('tr');
            keys.forEach((k) => {
              const showCompact = ['apellido', 'nombre', 'dni', 'empresa', 'numCausa', 'diagnostico'].includes(k);
              if (tipo === 'completo' || (tipo === 'compacto' && showCompact)) {
                const td = document.createElement('td');
                td.textContent = item[k] ?? '';
                row.appendChild(td);
              }
            });
            tbody.appendChild(row);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          const h3 = document.createElement('h3');
          h3.textContent = `Sección ${path}`;
          container.appendChild(h3);
          container.appendChild(table);
        }
      }
    }

    function filterListado() {
      const searchValue = (document.getElementById('searchInput')?.value || '').toLowerCase();
      const container = document.getElementById('listadoContainer');
      if (!container) return;
      container.innerHTML = '';

      Object.keys(listadoData).forEach((path) => {
        const data = listadoData[path];
        const firstItem = Object.values(data)[0] || {};
        const keys = Object.keys(firstItem);

        const filtered = Object.values(data).filter((item) => {
          const a = (item['dni'] || '').toLowerCase();
          const b = (item['nombre'] || '').toLowerCase();
          const c = (item['apellido'] || '').toLowerCase();
          return a.includes(searchValue) || b.includes(searchValue) || c.includes(searchValue);
        });

        if (filtered.length > 0) {
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');

          const headerRow = document.createElement('tr');
          keys.forEach((k) => {
            const showCompact = ['apellido', 'nombre', 'dni', 'empresa', 'numCausa', 'diagnostico'].includes(k);
            if (listadoTipo === 'completo' || (listadoTipo === 'compacto' && showCompact)) {
              const th = document.createElement('th');
              th.textContent = k;
              headerRow.appendChild(th);
            }
          });
          thead.appendChild(headerRow);

          filtered.forEach((item) => {
            const row = document.createElement('tr');
            keys.forEach((k) => {
              const showCompact = ['apellido', 'nombre', 'dni', 'empresa', 'numCausa', 'diagnostico'].includes(k);
              if (listadoTipo === 'completo' || (listadoTipo === 'compacto' && showCompact)) {
                const td = document.createElement('td');
                td.textContent = item[k] ?? '';
                row.appendChild(td);
              }
            });
            tbody.appendChild(row);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          const h3 = document.createElement('h3');
          h3.textContent = `Sección ${path}`;
          container.appendChild(h3);
          container.appendChild(table);
        }
      });
    }

    // --- Utilidades de CRUD para formularios/tablitas ---
    function setupSection(formId, path, tableId) {
      const form = document.getElementById(formId);
      const tableBody = document.getElementById(tableId);
      if (!form || !tableBody) return;

      // Crear/Actualizar (si hay data-edit-id se actualiza)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {};
        new FormData(form).forEach((v, k) => (payload[k] = v));

        if (form.dataset.editId) {
          const itemRef = window.dbRef(window.db, `${path}/${form.dataset.editId}`);
          await window.dbUpdate(itemRef, payload);
        } else {
          const sectionRef = window.dbRef(window.db, path);
          await window.dbSet(window.dbPush(sectionRef), payload);
        }
        resetForm(formId);
      });

      // Pintar tabla en vivo
      const sectionRef = window.dbRef(window.db, path);
      window.dbOn(sectionRef, (snapshot) => {
        tableBody.innerHTML = '';
        if (!snapshot.exists()) return;
        const data = snapshot.val();

        Object.entries(data).forEach(([id, item]) => {
          const tr = document.createElement('tr');

          // Celdas de datos (orden según las keys del primer objeto)
          const keys = Object.keys(item);
          keys.forEach((k) => {
            const td = document.createElement('td');
            td.textContent = item[k] ?? '';
            tr.appendChild(td);
          });

          // Acciones
          const tdActions = document.createElement('td');
          tdActions.className = 'actions';

          const btnEdit = document.createElement('button');
          btnEdit.className = 'btn btn-warning';
          btnEdit.type = 'button';
          btnEdit.textContent = 'Editar';
          btnEdit.onclick = () => {
            // Cargar datos en formulario
            Object.entries(item).forEach(([k, v]) => {
              if (form.elements[k]) form.elements[k].value = v;
            });
            form.dataset.editId = id;
            form.dataset.path = path;
            mostrarSeccion(path); // enfoca la sección actual
          };

          const btnDelete = document.createElement('button');
          btnDelete.className = 'btn btn-danger';
          btnDelete.type = 'button';
          btnDelete.textContent = 'Eliminar';
          btnDelete.onclick = async () => {
            if (confirm('¿Seguro que deseas eliminar este registro?')) {
              const itemRef = window.dbRef(window.db, `${path}/${id}`);
              await window.dbRemove(itemRef);
            }
          };

          tdActions.append(btnEdit, btnDelete);
          const tdActionsWrap = document.createElement('td');
          tdActionsWrap.appendChild(tdActions);
          tr.appendChild(tdActionsWrap);

          tableBody.appendChild(tr);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar secciones
      setupSection('personalForm', 'personal', 'personalTable');
      setupSection('judicialForm', 'judicial', 'judicialTable');
      setupSection('medicaForm', 'medica', 'medicaTable');
      setupSection('laboralForm', 'laboral', 'laboralTable');

      // Pequeña batería de tests (solo DOM) para evitar errores futuros
      runDomTests();
    });

    // --- TESTS ---
    function assert(cond, msg) { if (!cond) throw new Error(msg); }
    function runDomTests() {
      try {
        // Test 1: Existen todas las secciones requeridas
        ['personalForm','judicialForm','medicaForm','laboralForm','listado'].forEach(id => {
          assert(!!document.getElementById(id), `Falta el elemento #${id}`);
        });

        // Test 2: Cambios de sección no arrojan errores
        mostrarSeccion('personal');
        assert(document.getElementById('personalForm').classList.contains('active'), 'personal no activa');

        mostrarSeccion('judicial');
        assert(document.getElementById('judicialForm').classList.contains('active'), 'judicial no activa');

        // Test 3: Llamado seguro a listado (no valida datos remotos)
        try {
          mostrarSeccion('listado');
          // Si Firebase no responde, igual no debe crashear el DOM
          assert(document.getElementById('listado').classList.contains('active'), 'listado no activo');
        } catch (e) {
          console.warn('Test listado: omitido por conexión remota', e);
        }

        console.log('%cTests DOM OK', 'color: green; font-weight: bold');
      } catch (e) {
        console.error('Fallo en tests DOM:', e.message);
      }
    }
  </script>
</body>
</html>
